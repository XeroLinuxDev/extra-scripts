#!/usr/bin/env bash
# ==========================================================
#   Arch Linux Plymouth Wizard (Final Version)
#   NO SUDO on start — Real theme detection in filesystem
# ==========================================================

set -euo pipefail

# =========================[ COLORS ]========================
RESET="\e[0m"
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
BOLD="\e[1m"

# =====================[ Centered Section Header ]=====================
section() {
    local text="$1"
    local width=47
    local padding=$(( (width - ${#text}) / 2 ))
    local pad=""
    printf -v pad "%*s" "$padding"

    printf "\n${MAGENTA}${BOLD}───────────────────────────────────────────────\n"
    printf "%s%s%s\n" "$pad" "$text" "$pad"
    printf "───────────────────────────────────────────────${RESET}\n"
}

# =========================[ HELPERS ]========================
info()   { printf "${CYAN}➜ %s${RESET}\n" "$1"; }
ok()     { printf "${GREEN}✔ %s${RESET}\n" "$1"; }
warn()   { printf "${YELLOW}⚠ %s${RESET}\n" "$1"; }
error()  { printf "${RED}✖ %s${RESET}\n" "$1"; exit 1; }

BACKUP_DIR="/etc/plymouth-backups"
TIME_STAMP="$(date +%Y%m%d_%H%M%S)"

# ==========================================================
# BACKUP BOTH CONFIG FILES
# ==========================================================
backup_configs() {
    section "BACKUP — Saving Current Boot Configs"

    local mk_src="/etc/mkinitcpio.conf"
    local grub_src="/etc/default/grub"

    if [[ ! -d "$BACKUP_DIR" ]]; then
        info "Creating backup directory: $BACKUP_DIR"
        sudo mkdir -p "$BACKUP_DIR"
    fi

    local mk_bak="$BACKUP_DIR/mkinitcpio.conf.bak_$TIME_STAMP"
    local grub_bak="$BACKUP_DIR/grub.bak_$TIME_STAMP"

    info "Backing up mkinitcpio.conf → $mk_bak"
    sudo cp "$mk_src" "$mk_bak"

    info "Backing up grub → $grub_bak"
    sudo cp "$grub_src" "$grub_bak"

    ok "Backup completed successfully."
}

# ==========================================================
# FIX HOOKS: Insert 'plymouth' right after 'udev'
# ==========================================================
fix_mkinitcpio_hooks() {
    info "Updating mkinitcpio HOOKS (plymouth → after udev)…"

    local file="/etc/mkinitcpio.conf"
    local hooks_line
    hooks_line=$(grep "^HOOKS=" "$file" || true)

    if [[ -z "$hooks_line" ]]; then
        error "HOOKS= line not found in $file"
    fi

    local hooks_raw
    hooks_raw=$(echo "$hooks_line" | sed -E 's/^HOOKS=\((.*)\)/\1/')

    IFS=' ' read -r -a hooks <<< "$hooks_raw"

    local no_ply=()
    for h in "${hooks[@]}"; do
        [[ "$h" != "plymouth" ]] && no_ply+=("$h")
    done

    local final=()
    local inserted=false

    for h in "${no_ply[@]}"; do
        final+=("$h")
        if [[ "$h" == "udev" ]]; then
            final+=("plymouth")
            inserted=true
        fi
    done

    if [[ "$inserted" == false ]]; then
        warn "'udev' not found — prepending udev + plymouth"
        final=("udev" "plymouth" "${no_ply[@]}")
    fi

    local new_hooks="${final[*]}"

    info "New HOOKS=($new_hooks)"
    sudo sed -i "s|^HOOKS=.*|HOOKS=($new_hooks)|" "$file"

    ok "mkinitcpio HOOKS updated."
}

# ==========================================================
# SAFE GRUB FLAG APPENDING
# ==========================================================
append_kernel_flags() {
    local flags=("quiet" "splash" "loglevel=3" "rd.udev.log_priority=3" "vt.global_cursor_default=0")

    local current
    current=$(grep '^GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub \
        | sed 's/^GRUB_CMDLINE_LINUX_DEFAULT="//;s/"$//')

    local new="$current"

    for f in "${flags[@]}"; do
        [[ "$current" != *"$f"* ]] && new="$new $f"
    done

    new="$(echo "$new" | xargs)"

    info "Appending GRUB flags…"
    sudo sed -i "s|^GRUB_CMDLINE_LINUX_DEFAULT=.*|GRUB_CMDLINE_LINUX_DEFAULT=\"$new\"|" /etc/default/grub

    ok "Updated GRUB flags:"
    echo "    $new"
}

# ==========================================================
# NATIVE REPO THEME PACKAGE LIST
# ==========================================================
get_theme_list() {
    mapfile -t THEMES < <(
        pacman -Ss plymouth-theme 2>/dev/null \
        | grep -oP '^[^/]+/\Kplymouth-theme[^ ]+' \
        | sort -u
    )
}

# ==========================================================
# REAL THEME DETECTION FROM FILESYSTEM
# ==========================================================
detect_installed_theme() {
    mapfile -t FOUND_THEMES < <(
        find /usr/share/plymouth/themes -mindepth 1 -maxdepth 1 -type d \
        | while read -r dir; do
            if ls "$dir"/*.plymouth &>/dev/null; then
                basename "$dir"
            fi
        done
    )

    if [[ ${#FOUND_THEMES[@]} -eq 0 ]]; then
        error "No .plymouth themes found in /usr/share/plymouth/themes."
    fi

    if [[ ${#FOUND_THEMES[@]} -eq 1 ]]; then
        THEME_NAME="${FOUND_THEMES[0]}"
        return
    fi

    echo
    info "Multiple installed themes detected."
    for i in "${!FOUND_THEMES[@]}"; do
        printf "${BLUE} [%d]${RESET} %s\n" "$i" "${FOUND_THEMES[$i]}"
    done

    printf "\n${YELLOW}Choose theme directory:${RESET} "
    read -r idx

    if ! [[ "$idx" =~ ^[0-9]+$ ]] || (( idx < 0 || idx >= ${#FOUND_THEMES[@]} )); then
        error "Invalid theme selection."
    fi

    THEME_NAME="${FOUND_THEMES[$idx]}"
}

# ==========================================================
# STEP 1 — INSTALL PLYMOUTH
# ==========================================================
install_plymouth_step() {
    section "STEP 1 — Install & Activate Plymouth"

    backup_configs

    info "Installing Plymouth…"
    sudo pacman -Sy --needed --noconfirm plymouth plymouth-kcm

    fix_mkinitcpio_hooks

    printf "${YELLOW}Append silent boot flags? [Y/n] ${RESET}"
    read -r yn

    [[ -z "${yn:-}" || "$yn" =~ ^[Yy]$ ]] && append_kernel_flags

    info "Rebuilding initramfs…"
    sudo mkinitcpio -P

    info "Updating GRUB…"
    sudo grub-mkconfig -o /boot/grub/grub.cfg

    ok "Plymouth installed and enabled."
}

# ==========================================================
# STEP 2 — INSTALL + APPLY THEME
# ==========================================================
theme_selection_step() {
    section "STEP 2 — Install & Apply Theme"

    get_theme_list
    [[ ${#THEMES[@]} -gt 0 ]] || error "No plymouth-theme packages available."

    printf "${BOLD}Available Themes From Repos:${RESET}\n"
    for i in "${!THEMES[@]}"; do
        printf "${BLUE} [%d]${RESET} %s\n" "$i" "${THEMES[$i]}"
    done

    printf "\n${YELLOW}Choose theme package number:${RESET} "
    read -r idx

    if ! [[ "$idx" =~ ^[0-9]+$ ]] || (( idx < 0 || idx >= ${#THEMES[@]} )); then
        error "Invalid selection."
    fi

    local pkg="${THEMES[$idx]}"

    info "Installing: $pkg"
    sudo pacman -Sy --needed --noconfirm "$pkg"

    info "Detecting installed themes..."
    detect_installed_theme

    info "Applying theme: $THEME_NAME"
    sudo plymouth-set-default-theme -R "$THEME_NAME"

    ok "Theme '$THEME_NAME' applied successfully."
}

# ==========================================================
# STEP 3 — RESTORE ORIGINAL SYSTEM
# ==========================================================
restore_step() {
    section "STEP 3 — Restore System"

    local mk gr
    mk=$(ls -1t "$BACKUP_DIR"/mkinitcpio.conf.bak_* 2>/dev/null | head -n 1 || true)
    gr=$(ls -1t "$BACKUP_DIR"/grub.bak_* 2>/dev/null | head -n 1 || true)

    [[ -z "$mk" || -z "$gr" ]] && error "No backups found — cannot restore."

    local pkgs
    pkgs=$(pacman -Qq | grep '^plymouth' || true)

    if [[ -n "$pkgs" ]]; then
        warn "Removing Plymouth packages…"
        sudo pacman -Rns --noconfirm $pkgs
    fi

    warn "Restoring mkinitcpio.conf"
    sudo cp "$mk" /etc/mkinitcpio.conf

    warn "Restoring /etc/default/grub"
    sudo cp "$gr" /etc/default/grub

    info "Rebuilding initramfs…"
    sudo mkinitcpio -P

    info "Rebuilding GRUB…"
    sudo grub-mkconfig -o /boot/grub/grub.cfg

    ok "System restored."
}

# ==========================================================
# MAIN MENU
# ==========================================================
while true; do
    section "Plymouth Wizard – Main Menu"

    printf "${CYAN}${BOLD}Choose an action:${RESET}\n\n"
    printf "${GREEN} 1)${RESET} Install & Activate Plymouth\n"
    printf "${GREEN} 2)${RESET} Install & Apply Plymouth Theme\n"
    printf "${GREEN} 3)${RESET} Restore & Remove Plymouth Completely\n"
    echo
    printf "${RED} 4)${RESET} Exit Wizard\n\n"

    printf "${YELLOW}Enter choice:${RESET} "
    read -r choice

    case "$choice" in
        1) install_plymouth_step ;;
        2) theme_selection_step ;;
        3) restore_step ;;
        4)
            echo
            info "Exiting wizard. Goodbye!"
            exit 0
            ;;
        *)
            echo
            warn "Invalid option."
            ;;
    esac
done
