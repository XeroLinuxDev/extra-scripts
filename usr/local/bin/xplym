#!/usr/bin/env bash
# ==========================================================
#   Arch Linux Plymouth Wizard – Humanized + Submenu Edition
# ==========================================================

set -euo pipefail && clear

# =========================[ COLORS ]========================
RESET="\e[0m"
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
BOLD="\e[1m"

# =====================[ Centered Section Header ]=====================
section() {
    local text="$1"
    local width=47
    local padding=$(( (width - ${#text}) / 2 ))
    local pad=""
    printf -v pad "%*s" "$padding"

    printf "\n${MAGENTA}${BOLD}───────────────────────────────────────────────\n"
    printf "%s%s%s\n" "$pad" "$text" "$pad"
    printf "───────────────────────────────────────────────${RESET}\n"
}

# =========================[ HELPERS ]========================
info()   { printf "${CYAN}➜ %s${RESET}\n" "$1"; }
ok()     { printf "${GREEN}✔ %s${RESET}\n" "$1"; }
warn()   { printf "${YELLOW}⚠ %s${RESET}\n" "$1"; }
error()  { printf "${RED}✖ %s${RESET}\n" "$1"; exit 1; }

BACKUP_DIR="/etc/plymouth-backups"
TIME_STAMP="$(date +%Y%m%d_%H%M%S)"

# ==========================================================
# Humanize package names (plymouth-theme-arch-charge-git → Arch Charge)
# ==========================================================
humanize_pkg_name() {
    local pkg="$1"

    # Remove prefix and suffix
    local name="${pkg#plymouth-theme-}"   # remove prefix
    name="${name%-git}"                   # remove -git if present

    # Replace separators with spaces
    name="${name//-/ }"
    name="${name//_/ }"

    # Capitalize each word
    local final=""
    for word in $name; do
        final+="$(tr '[:lower:]' '[:upper:]' <<< "${word:0:1}")${word:1} "
    done

    echo "${final::-1}"
}

# ==========================================================
# Generic multi-column printer with padded columns
# labels array is passed by name (bash 4+)
# ==========================================================
print_indexed_columns() {
    local -n labels_ref=$1

    local count=${#labels_ref[@]}
    (( count == 0 )) && return

    local cols
    cols=$(tput cols 2>/dev/null || echo 80)

    local max_len=0
    for label in "${labels_ref[@]}"; do
        (( ${#label} > max_len )) && max_len=${#label}
    done

    local col_width=$((max_len + 8))
    local num_cols=1

    if (( cols >= col_width * 3 )); then
        num_cols=3
    elif (( cols >= col_width * 2 )); then
        num_cols=2
    fi

    for ((i = 0; i < count; i++)); do
        local entry="[$i] ${labels_ref[$i]}"
        printf "%-*s" "$col_width" "$entry"

        # CORRECTED LINE
        if ((( (i + 1) % num_cols == 0 ))); then
            printf "\n"
        fi
    done

    printf "\n"
}

# ==========================================================
# BACKUP BOTH CONFIG FILES
# ==========================================================
backup_configs() {
    section "BACKUP — Saving System Boot Configs"

    if [[ ! -d "$BACKUP_DIR" ]]; then
        info "Creating backup directory at $BACKUP_DIR"
        sudo mkdir -p "$BACKUP_DIR"
    fi

    sudo cp /etc/mkinitcpio.conf "$BACKUP_DIR/mkinitcpio.conf.bak_$TIME_STAMP"
    sudo cp /etc/default/grub "$BACKUP_DIR/grub.bak_$TIME_STAMP"

    ok "Backup created."
}

# ==========================================================
# Insert plymouth HOOK after udev
# ==========================================================
fix_mkinitcpio_hooks() {
    info "Updating mkinitcpio HOOKS…"

    local file="/etc/mkinitcpio.conf"
    local hooks_line
    hooks_line=$(grep "^HOOKS=" "$file" || true)
    [[ -z "$hooks_line" ]] && error "HOOKS= line not found in $file"

    local raw="${hooks_line#HOOKS=(}"
    raw="${raw%)}"

    IFS=' ' read -r -a hooks <<< "$raw"

    local cleaned=()
    for h in "${hooks[@]}"; do
        [[ "$h" != "plymouth" ]] && cleaned+=("$h")
    done

    local final=()
    local inserted=false

    for h in "${cleaned[@]}"; do
        final+=("$h")
        if [[ "$h" == "udev" ]]; then
            final+=("plymouth")
            inserted=true
        fi
    done

    if ! $inserted; then
        warn "udev not found — prepending udev + plymouth"
        final=("udev" "plymouth" "${cleaned[@]}")
    fi

    sudo sed -i "s|^HOOKS=.*|HOOKS=(${final[*]})|" "$file"
    ok "HOOKS updated."
}

# ==========================================================
# SAFE GRUB FLAG APPENDING (append only, never overwrite)
# ==========================================================
append_kernel_flags() {
    local file="/etc/default/grub"
    local flags=("splash" "rd.udev.log_priority=3" "vt.global_cursor_default=0")

    local line
    line=$(grep '^GRUB_CMDLINE_LINUX_DEFAULT=' "$file" || true)
    [[ -z "$line" ]] && error "GRUB_CMDLINE_LINUX_DEFAULT not found in $file"

    local current="${line#GRUB_CMDLINE_LINUX_DEFAULT=\"}"
    current="${current%\"}"

    local new="$current"

    for f in "${flags[@]}"; do
        if [[ ! " $new " =~ " $f " ]]; then
            new="$new $f"
        fi
    done

    new=$(echo "$new" | xargs)

    info "Updating GRUB_CMDLINE_LINUX_DEFAULT…"
    sudo sed -i \
        "s|^GRUB_CMDLINE_LINUX_DEFAULT=\".*\"|GRUB_CMDLINE_LINUX_DEFAULT=\"$new\"|" \
        "$file"

    ok "Updated GRUB_CMDLINE_LINUX_DEFAULT:"
    echo "    $new"
}

# ==========================================================
# GET PACKAGE LIST (HUMANIZED NAMES)
# ==========================================================
get_theme_pkg_list() {
    THEMES_PKGS=()
    THEMES_NAMES=()

    while IFS= read -r pkgref; do
        local pkg="${pkgref#*/}"       # strip repo/ prefix
        pkg="${pkg%% *}"               # remove version
        local readable
        readable=$(humanize_pkg_name "$pkg")

        THEMES_PKGS+=("$pkg")
        THEMES_NAMES+=("$readable")
    done < <(pacman -Ss plymouth-theme 2>/dev/null | awk '/^[^/]+\/plymouth-theme/ {print $1}')
}

# ==========================================================
# INSTALLED THEMES — REAL DETECTION USING .PLYMOUTH
# ==========================================================
select_theme_from_fs() {
    local plyfiles=()
    THEME_IDS=()
    THEME_TITLES=()

    mapfile -t plyfiles < <(find /usr/share/plymouth/themes -type f -name '*.plymouth' 2>/dev/null)

    (( ${#plyfiles[@]} == 0 )) && error "No installed Plymouth themes found."

    for file in "${plyfiles[@]}"; do
        local id name
        id=$(basename "${file%.plymouth}")
        name=$(grep -m1 "^Name=" "$file" | cut -d'=' -f2-)

        [[ -z "$name" ]] && name="$id"

        THEME_IDS+=("$id")
        THEME_TITLES+=("$name")
    done

    printf "${BOLD}Installed Plymouth Themes:${RESET}\n"
    print_indexed_columns THEME_TITLES

    printf "${YELLOW}Choose theme to activate:${RESET} "
    read -r idx

    if ! [[ "$idx" =~ ^[0-9]+$ ]] || (( idx < 0 || idx >= ${#THEME_IDS[@]} )); then
        error "Invalid selection."
    fi

    THEME_NAME="${THEME_IDS[$idx]}"
}

# ==========================================================
# STEP 1 — INSTALL PLYMOUTH
# ==========================================================
install_plymouth_step() {
    section "STEP 1 — Install & Activate Plymouth"

    backup_configs

    info "Installing plymouth & plymouth-kcm…"
    sudo pacman -Sy --needed --noconfirm plymouth plymouth-kcm

    fix_mkinitcpio_hooks

    printf "${YELLOW}Append splash / rd.udev.log_priority / vt cursor flags? [Y/n]: ${RESET}"
    read -r yn

    if [[ -z "${yn:-}" || "$yn" =~ ^[Yy]$ ]]; then
        append_kernel_flags
    else
        warn "Skipping GRUB_CMDLINE_LINUX_DEFAULT modification."
    fi

    info "Rebuilding initramfs…"
    sudo mkinitcpio -P

    info "Regenerating GRUB config…"
    sudo grub-mkconfig -o /boot/grub/grub.cfg

    ok "Plymouth installed and activated. Reboot to see it."
}

# ==========================================================
# THEME MANAGEMENT — INSTALL NEW THEME
# ==========================================================
theme_install_step() {
    section "THEMES — Install New Theme Package"

    get_theme_pkg_list
    (( ${#THEMES_PKGS[@]} == 0 )) && error "No plymouth-theme packages found in repos."

    printf "${BOLD}Available Theme Packages:${RESET}\n"
    print_indexed_columns THEMES_NAMES

    printf "${YELLOW}Choose package to install:${RESET} "
    read -r idx

    if ! [[ "$idx" =~ ^[0-9]+$ ]] || (( idx < 0 || idx >= ${#THEMES_PKGS[@]} )); then
        error "Invalid selection."
    fi

    local pkg="${THEMES_PKGS[$idx]}"

    info "Installing package: $pkg"
    sudo pacman -Sy --needed --noconfirm "$pkg"

    ok "Theme package '$pkg' installed. You can now apply it from the Theme Management menu."
}

# ==========================================================
# THEME MANAGEMENT — APPLY EXISTING THEME
# ==========================================================
theme_apply_step() {
    section "THEMES — Apply / Change Installed Theme"

    info "Scanning installed themes…"
    select_theme_from_fs

    info "Applying theme: $THEME_NAME"
    sudo plymouth-set-default-theme -R "$THEME_NAME"

    ok "Theme '$THEME_NAME' applied. Reboot to see it."
}

# ==========================================================
# THEME MANAGEMENT SUBMENU
# ==========================================================
theme_management_menu() {
    while true; do
        section "2) Plymouth Theme Management"

        printf "${CYAN}${BOLD}Choose an option:${RESET}\n\n"
        printf "   ${GREEN}a)${RESET} Install New Theme.\n"
        printf "   ${GREEN}b)${RESET} Apply/Change Current Theme\n"
        echo
        printf "   ${RED}m)${RESET} Back to Main Menu\n\n"

        printf "${YELLOW}Enter choice (a/b/m):${RESET} "
        read -r opt

        case "$opt" in
            a|A) theme_install_step ;;
            b|B) theme_apply_step ;;
            m|M) return ;;
            *)   warn "Invalid option. Try again." ;;
        esac
    done
}

# ==========================================================
# STEP 3 — RESTORE SYSTEM TO PRE-PLYMOUTH STATE
# ==========================================================
restore_step() {
    section "STEP 3 — Restore System"

    local mk gr
    mk=$(ls -1t "$BACKUP_DIR"/mkinitcpio.conf.bak_* 2>/dev/null | head -n1 || true)
    gr=$(ls -1t "$BACKUP_DIR"/grub.bak_* 2>/dev/null | head -n1 || true)

    [[ -z "$mk" || -z "$gr" ]] && error "No backups found in $BACKUP_DIR — cannot restore."

    local pkgs
    pkgs=$(pacman -Qq | grep '^plymouth' || true)

    if [[ -n "$pkgs" ]]; then
        warn "Removing all Plymouth-related packages…"
        sudo pacman -Rns --noconfirm $pkgs
    else
        warn "No Plymouth packages installed. Skipping removal."
    fi

    warn "Restoring /etc/mkinitcpio.conf from backup."
    sudo cp "$mk" /etc/mkinitcpio.conf

    warn "Restoring /etc/default/grub from backup."
    sudo cp "$gr" /etc/default/grub

    info "Rebuilding initramfs…"
    sudo mkinitcpio -P

    info "Regenerating GRUB config…"
    sudo grub-mkconfig -o /boot/grub/grub.cfg

    ok "System restored to pre-Plymouth state."
}

# ==========================================================
# MAIN MENU — NO SUDO HERE
# ==========================================================
while true; do
    section "Plymouth Wizard — Main Menu"

    printf "${CYAN}${BOLD}Choose an action:${RESET}\n\n"
    printf "${GREEN} 1)${RESET} Install & Activate Plymouth\n"
    printf "${GREEN} 2)${RESET} Theme Management\n"
    printf "${GREEN} 3)${RESET} Restore System\n"
    echo
    printf "${RED} 4)${RESET} Exit Wizard\n\n"

    printf "${YELLOW}Enter choice:${RESET} "
    read -r choice

    case "$choice" in
        1) install_plymouth_step ;;
        2) theme_management_menu ;;
        3) restore_step ;;
        4) info "Exiting. Goodbye!"; exit 0 ;;
        *) warn "Invalid option. Try again." ;;
    esac
done
