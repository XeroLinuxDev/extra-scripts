#!/usr/bin/env bash
# ==========================================================
#   Arch Linux Plymouth Wizard – Humanized + Submenu Edition
# ==========================================================

set -euo pipefail && clear

# =========================[ COLORS ]========================
RESET="\e[0m"
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
BOLD="\e[1m"

# =====================[ Section Header ]=====================
section() {
    local text="$1"
    local width=47
    local padding=$(( (width - ${#text}) / 2 ))
    printf "\n${MAGENTA}${BOLD}───────────────────────────────────────────────\n"
    printf "%*s%s%*s\n" "$padding" "" "$text" "$padding" ""
    printf "───────────────────────────────────────────────${RESET}\n"
}

# =========================[ HELPERS ]========================
info()   { printf "${CYAN}➜ %s${RESET}\n" "$1"; }
ok()     { printf "${GREEN}✔ %s${RESET}\n" "$1"; }
warn()   { printf "${YELLOW}⚠ %s${RESET}\n" "$1"; }
error()  { printf "${RED}✖ %s${RESET}\n" "$1"; exit 1; }

BACKUP_DIR="/etc/plymouth-backups"
TIME_STAMP="$(date +%Y%m%d_%H%M%S)"

# ==========================================================
# Humanize package names (plymouth-theme-arch-charge-git → Arch Charge)
# ==========================================================
humanize_pkg_name() {
    local pkg="$1"
    local name="${pkg#plymouth-theme-}"
    name="${name%-git}"
    name="${name//-/ }"
    name="${name//_/ }"

    local final=""
    for word in $name; do
        final+="$(tr '[:lower:]' '[:upper:]' <<< "${word:0:1}")${word:1} "
    done
    echo "${final::-1}"
}

# ==========================================================
# Multi-column padded printer
# ==========================================================
print_indexed_columns() {
    local -n labels_ref=$1
    local count=${#labels_ref[@]}
    (( count == 0 )) && return

    local cols
    cols=$(tput cols 2>/dev/null || echo 80)

    local max_len=0
    for label in "${labels_ref[@]}"; do
        (( ${#label} > max_len )) && max_len=${#label}
    done

    local col_width=$((max_len + 8))
    local num_cols=1

    if (( cols >= col_width * 3 )); then
        num_cols=3
    elif (( cols >= col_width * 2 )); then
        num_cols=2
    fi

    for ((i = 0; i < count; i++)); do
        printf "%-*s" "$col_width" "[$i] ${labels_ref[$i]}"
        if ((( (i + 1) % num_cols == 0 ))); then
            printf "\n"
        fi
    done
    printf "\n"
}

# ==========================================================
# Backup configs
# ==========================================================
backup_configs() {
    section "BACKUP — Saving System Boot Configs"

    [[ ! -d "$BACKUP_DIR" ]] && sudo mkdir -p "$BACKUP_DIR"

    sudo cp /etc/mkinitcpio.conf "$BACKUP_DIR/mkinitcpio.conf.bak_$TIME_STAMP"
    sudo cp /etc/default/grub "$BACKUP_DIR/grub.bak_$TIME_STAMP"

    ok "Backup created."
}

# ==========================================================
# Fix mkinitcpio hooks
# ==========================================================
fix_mkinitcpio_hooks() {
    info "Updating mkinitcpio HOOKS…"

    local file="/etc/mkinitcpio.conf"
    local hooks_line
    hooks_line=$(grep "^HOOKS=" "$file" || true)
    [[ -z "$hooks_line" ]] && error "HOOKS= line not found"

    local raw="${hooks_line#HOOKS=(}"
    raw="${raw%)}"

    IFS=' ' read -r -a hooks <<< "$raw"

    local cleaned=()
    for h in "${hooks[@]}"; do
        [[ "$h" != "plymouth" ]] && cleaned+=("$h")
    done

    local final=()
    local inserted=false

    for h in "${cleaned[@]}"; do
        final+=("$h")
        if [[ "$h" == "udev" ]]; then
            final+=("plymouth")
            inserted=true
        fi
    done

    if ! $inserted; then
        warn "udev not found — prepending udev + plymouth"
        final=("udev" "plymouth" "${cleaned[@]}")
    fi

    sudo sed -i "s|^HOOKS=.*|HOOKS=(${final[*]})|" "$file"
    ok "HOOKS updated."
}

# ==========================================================
# Append only the required GRUB flags
# ==========================================================
append_kernel_flags() {
    local file="/etc/default/grub"
    local flags=("splash" "rd.udev.log_priority=3" "vt.global_cursor_default=0")

    local line
    line=$(grep '^GRUB_CMDLINE_LINUX_DEFAULT=' "$file" || true)
    [[ -z "$line" ]] && error "GRUB_CMDLINE_LINUX_DEFAULT not found"

    local current="${line#GRUB_CMDLINE_LINUX_DEFAULT=\"}"
    current="${current%\"}"

    local new="$current"

    for f in "${flags[@]}"; do
        if [[ ! " $new " =~ " $f " ]]; then
            new="$new $f"
        fi
    done

    new=$(echo "$new" | xargs)

    sudo sed -i \
        "s|^GRUB_CMDLINE_LINUX_DEFAULT=\".*\"|GRUB_CMDLINE_LINUX_DEFAULT=\"$new\"|" \
        "$file"

    ok "Updated GRUB_CMDLINE_LINUX_DEFAULT:"
    echo "    $new"
}

# ==========================================================
# Get theme packages (humanized names)
# ==========================================================
get_theme_pkg_list() {
    THEMES_PKGS=()
    THEMES_NAMES=()

    while IFS= read -r ref; do
        local pkg="${ref#*/}"
        pkg="${pkg%% *}"

        THEMES_PKGS+=("$pkg")
        THEMES_NAMES+=("$(humanize_pkg_name "$pkg")")

    done < <(pacman -Ss plymouth-theme 2>/dev/null | awk '/^[^/]+\/plymouth-theme/ {print $1}')
}

# ==========================================================
# Detect installed themes (.plymouth)
# ==========================================================
select_theme_from_fs() {
    local plyfiles=()
    THEME_IDS=()
    THEME_TITLES=()

    mapfile -t plyfiles < <(find /usr/share/plymouth/themes -type f -name '*.plymouth')

    (( ${#plyfiles[@]} == 0 )) && error "No installed themes found."

    for file in "${plyfiles[@]}"; do
        local id name
        id=$(basename "${file%.plymouth}")
        name=$(grep -m1 "^Name=" "$file" | cut -d'=' -f2-)
        [[ -z "$name" ]] && name="$id"

        THEME_IDS+=("$id")
        THEME_TITLES+=("$name")
    done

    printf "${BOLD}Installed Themes:${RESET}\n"
    print_indexed_columns THEME_TITLES

    printf "${YELLOW}Choose theme to activate:${RESET} "
    read -r idx

    if ! [[ "$idx" =~ ^[0-9]+$ ]] || (( idx < 0 || idx >= ${#THEME_IDS[@]} )); then
        error "Invalid selection."
    fi

    THEME_NAME="${THEME_IDS[$idx]}"
}

# ==========================================================
# Install & activate Plymouth
# ==========================================================
install_plymouth_step() {
    section "STEP 1 — Install & Activate Plymouth"

    backup_configs

    sudo pacman -Sy --needed --noconfirm plymouth plymouth-kcm

    fix_mkinitcpio_hooks

    printf "${YELLOW}Append splash/udev/cursor flags to GRUB? [Y/n]: ${RESET}"
    read -r yn
    [[ -z "${yn:-}" || "$yn" =~ ^[Yy]$ ]] && append_kernel_flags

    sudo mkinitcpio -P
    sudo grub-mkconfig -o /boot/grub/grub.cfg

    ok "Plymouth installed. Reboot to see it."
}

# ==========================================================
# THEME MANAGEMENT — Install theme package
# ==========================================================
theme_install_step() {
    section "THEMES — Install New Theme Package"
    echo
    get_theme_pkg_list
    (( ${#THEMES_PKGS[@]} == 0 )) && error "No theme packages found."
    echo
    printf "${BOLD}Available Theme Packages:${RESET}\n"
    echo
    print_indexed_columns THEMES_NAMES

    printf "${YELLOW}Choose package to install:${RESET} "
    read -r idx

    if ! [[ "$idx" =~ ^[0-9]+$ ]] || (( idx < 0 || idx >= ${#THEMES_PKGS[@]} )); then
        error "Invalid selection."
    fi

    local pkg="${THEMES_PKGS[$idx]}"

    sudo pacman -Sy --needed --noconfirm "$pkg"

    ok "Package '$pkg' installed."
}

# ==========================================================
# THEME MANAGEMENT — Apply installed theme
# ==========================================================
theme_apply_step() {
    section "THEMES — Apply/Change Current Theme"
    echo
    select_theme_from_fs
    echo
    sudo plymouth-set-default-theme -R "$THEME_NAME"

    ok "Theme '$THEME_NAME' applied. Reboot to see it."
}

# ==========================================================
# THEME MANAGEMENT SUBMENU
# ==========================================================
theme_management_menu() {
    while true; do
        section "Theme Management"
        echo
        printf "${GREEN}   a)${RESET} Install New Theme Package\n"
        printf "${GREEN}   b)${RESET} Apply / Change Installed Theme\n"
        echo
        printf "${RED}   m)${RESET} Back to Main Menu\n\n"

        printf "${YELLOW}Enter choice (a/b/m):${RESET} "
        read -r opt

        case "$opt" in
            a|A) theme_install_step ;;
            b|B) theme_apply_step ;;
            m|M) clear && return ;;
            *) warn "Invalid option. Try again." ;;
        esac
    done
}

# ==========================================================
# Restore system to pre-Plymouth state
# ==========================================================
restore_step() {
    section "STEP 3 — Restore System"

    local mk gr
    mk=$(ls -1t "$BACKUP_DIR"/mkinitcpio.conf.bak_* 2>/dev/null | head -n1 || true)
    gr=$(ls -1t "$BACKUP_DIR"/grub.bak_* 2>/dev/null | head -n1 || true)

    [[ -z "$mk" || -z "$gr" ]] && error "No backups found."

    local pkgs
    pkgs=$(pacman -Qq | grep '^plymouth' || true)

    [[ -n "$pkgs" ]] && sudo pacman -Rns --noconfirm $pkgs

    sudo cp "$mk" /etc/mkinitcpio.conf
    sudo cp "$gr" /etc/default/grub

    sudo mkinitcpio -P
    sudo grub-mkconfig -o /boot/grub/grub.cfg

    ok "System restored."
}

# ==========================================================
# MAIN MENU
# ==========================================================
while true; do
    section "Plymouth Wizard — Main Menu"

    printf "${GREEN} 1)${RESET} Install & Activate Plymouth\n"
    printf "${GREEN} 2)${RESET} Theme Management\n"
    printf "${GREEN} 3)${RESET} Restore System\n"
    echo
    printf "${RED} 4)${RESET} Exit Wizard\n\n"

    printf "${YELLOW}Enter choice:${RESET} "
    read -r choice

    case "$choice" in
        1) install_plymouth_step ;;
        2) theme_management_menu ;;
        3) restore_step ;;
        4) info "Goodbye!"; exit 0 ;;
        *) warn "Invalid option. Try again." ;;
    esac
done
