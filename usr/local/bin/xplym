#!/usr/bin/env bash
# ==========================================================
#   Arch Linux Plymouth Wizard (Final, No-Sudo-On-Start)
#   Install → Theme → Restore → Exit
# ==========================================================

set -euo pipefail

# =========================[ COLORS ]========================
RESET="\e[0m"
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
BOLD="\e[1m"

# =====================[ Centered Section Header ]=====================
section() {
    local text="$1"
    local width=47
    local padding=$(( (width - ${#text}) / 2 ))
    local pad=""
    printf -v pad "%*s" "$padding"

    printf "\n${MAGENTA}${BOLD}───────────────────────────────────────────────\n"
    printf "%s%s%s\n" "$pad" "$text" "$pad"
    printf "───────────────────────────────────────────────${RESET}\n"
}

# =========================[ HELPERS ]========================
info()   { printf "${CYAN}➜ %s${RESET}\n" "$1"; }
ok()     { printf "${GREEN}✔ %s${RESET}\n" "$1"; }
warn()   { printf "${YELLOW}⚠ %s${RESET}\n" "$1"; }
error()  { printf "${RED}✖ %s${RESET}\n" "$1"; exit 1; }

BACKUP_DIR="/etc/plymouth-backups"
TIME_STAMP="$(date +%Y%m%d_%H%M%S)"

# ==========================================================
# BACKUP BOTH CONFIG FILES
# ==========================================================
backup_configs() {
    section "BACKUP — Saving Current Boot Configs"

    local mk_src="/etc/mkinitcpio.conf"
    local grub_src="/etc/default/grub"

    # ensure backup dir exists (this is the *first* sudo use in option 1)
    if [[ ! -d "$BACKUP_DIR" ]]; then
        info "Creating backup directory: $BACKUP_DIR"
        sudo mkdir -p "$BACKUP_DIR"
    fi

    local mk_bak="$BACKUP_DIR/mkinitcpio.conf.bak_$TIME_STAMP"
    local grub_bak="$BACKUP_DIR/grub.bak_$TIME_STAMP"

    info "Backing up mkinitcpio.conf → $mk_bak"
    sudo cp "$mk_src" "$mk_bak"

    info "Backing up /etc/default/grub → $grub_bak"
    sudo cp "$grub_src" "$grub_bak"

    ok "Backup completed successfully."
}

# ==========================================================
# FIX HOOKS: Insert 'plymouth' right after 'udev'
# ==========================================================
fix_mkinitcpio_hooks() {
    info "Updating mkinitcpio HOOKS (plymouth → right after udev)…"

    local file="/etc/mkinitcpio.conf"
    local hooks_line
    hooks_line=$(grep "^HOOKS=" "$file" || true)

    if [[ -z "$hooks_line" ]]; then
        error "HOOKS= line not found in $file"
    fi

    local hooks_raw
    hooks_raw=$(echo "$hooks_line" | sed -E 's/^HOOKS=\((.*)\)/\1/')

    IFS=' ' read -r -a hooks <<< "$hooks_raw"

    # remove existing plymouth if present
    local new_hooks=()
    for h in "${hooks[@]}"; do
        [[ "$h" != "plymouth" ]] && new_hooks+=("$h")
    done

    local final_hooks=()
    local inserted=false

    for h in "${new_hooks[@]}"; do
        final_hooks+=("$h")
        if [[ "$h" == "udev" ]]; then
            final_hooks+=("plymouth")
            inserted=true
        fi
    done

    if [[ "$inserted" == false ]]; then
        warn "'udev' not found — prepending udev + plymouth"
        final_hooks=("udev" "plymouth" "${new_hooks[@]}")
    fi

    local final_hooks_str="${final_hooks[*]}"

    info "New HOOKS=($final_hooks_str)"
    sudo sed -i "s|^HOOKS=.*|HOOKS=($final_hooks_str)|" "$file"

    ok "mkinitcpio HOOKS updated."
}

# ==========================================================
# SAFE GRUB FLAG APPENDING (NEVER REMOVE EXISTING FLAGS)
# ==========================================================
append_kernel_flags() {
    local flags_to_add=("quiet" "splash" "loglevel=3" "rd.udev.log_priority=3" "vt.global_cursor_default=0")

    local current
    current=$(grep '^GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub \
        | sed -e 's/^GRUB_CMDLINE_LINUX_DEFAULT="//' -e 's/"$//')

    local new="$current"

    for flag in "${flags_to_add[@]}"; do
        if [[ "$current" != *"$flag"* ]]; then
            new="$new $flag"
        fi
    done

    new="$(echo "$new" | xargs)"

    info "Appending required GRUB flags safely…"
    sudo sed -i "s|^GRUB_CMDLINE_LINUX_DEFAULT=.*|GRUB_CMDLINE_LINUX_DEFAULT=\"$new\"|" /etc/default/grub

    ok "GRUB flags updated:"
    echo "    $new"
}

# ==========================================================
# THEME DETECTION + LISTING
# ==========================================================
get_theme_list() {
    mapfile -t THEMES < <(
        pacman -Ss '^plymouth-theme' \
        | awk '/^community\/|^extra\// {print $1}' \
        | cut -d'/' -f2 \
        | cut -d' ' -f1
    )
}

detect_installed_theme_name() {
    local pkg="$1"
    local raw="${pkg/plymouth-theme-/}"

    local path
    path=$(find /usr/share/plymouth/themes -maxdepth 1 -type d -iname "$raw*" | head -n 1 || true)

    if [[ -z "$path" ]]; then
        error "Cannot locate theme directory for: $pkg"
    fi

    THEME_NAME="$(basename "$path")"

    if [[ ! -f "/usr/share/plymouth/themes/$THEME_NAME/$THEME_NAME.plymouth" ]]; then
        error "Theme file missing: /usr/share/plymouth/themes/$THEME_NAME/$THEME_NAME.plymouth"
    fi
}

# ==========================================================
# STEP 1 — INSTALL PLYMOUTH
# ==========================================================
install_plymouth_step() {
    section "STEP 1 — Install & Activate Plymouth"

    backup_configs

    info "Installing Plymouth core packages…"
    sudo pacman -Sy --needed --noconfirm plymouth plymouth-kcm

    fix_mkinitcpio_hooks

    printf "${YELLOW}Append silent-boot flags (quiet splash loglevel=3 rd.udev.log_priority=3 vt.global_cursor_default=0)? [Y/n] ${RESET}"
    read -r yn

    if [[ -z "${yn:-}" || "$yn" =~ ^[Yy]$ ]]; then
        append_kernel_flags
    else
        warn "Skipping GRUB flag changes."
    fi

    info "Rebuilding initramfs (mkinitcpio -P)…"
    sudo mkinitcpio -P

    info "Regenerating GRUB config…"
    sudo grub-mkconfig -o /boot/grub/grub.cfg

    ok "Plymouth installed and enabled. Reboot to see it in action."
}

# ==========================================================
# STEP 2 — INSTALL + APPLY THEME
# ==========================================================
theme_selection_step() {
    section "STEP 2 — Plymouth Theme Selection"

    get_theme_list
    [[ ${#THEMES[@]} -gt 0 ]] || error "No plymouth-theme packages found in repositories."

    printf "${BOLD}Available Plymouth Themes:${RESET}\n"
    for i in "${!THEMES[@]}"; do
        printf "${BLUE} [%d]${RESET} %s\n" "$i" "${THEMES[$i]}"
    done

    printf "\n${YELLOW}Choose theme number:${RESET} "
    read -r choice

    if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 0 || choice >= ${#THEMES[@]} )); then
        error "Invalid selection."
    fi

    local pkg="${THEMES[$choice]}"

    info "Installing theme package: $pkg"
    sudo pacman -Sy --needed --noconfirm "$pkg"

    detect_installed_theme_name "$pkg"

    info "Activating theme: $THEME_NAME"
    sudo plymouth-set-default-theme -R "$THEME_NAME"

    ok "Theme '$THEME_NAME' applied. Reboot to see it."
}

# ==========================================================
# STEP 3 — RESTORE SYSTEM (REMOVE PLYMOUTH COMPLETELY)
# ==========================================================
restore_step() {
    section "STEP 3 — Restore System to Pre-Plymouth"

    local mk_backup latest_grub_backup

    mk_backup=$(ls -1t "$BACKUP_DIR"/mkinitcpio.conf.bak_* 2>/dev/null | head -n 1 || true)
    latest_grub_backup=$(ls -1t "$BACKUP_DIR"/grub.bak_* 2>/dev/null | head -n 1 || true)

    if [[ -z "$mk_backup" || -z "$latest_grub_backup" ]]; then
        error "No backups found in $BACKUP_DIR. Cannot restore."
    fi

    info "Detecting installed Plymouth-related packages…"
    local installed_pkgs
    installed_pkgs=$(pacman -Qq | grep '^plymouth' || true)

    if [[ -n "$installed_pkgs" ]]; then
        warn "Removing all Plymouth-related packages…"
        sudo pacman -Rns --noconfirm $installed_pkgs
    else
        warn "No Plymouth packages detected. Skipping removal."
    fi

    warn "Restoring /etc/mkinitcpio.conf from: $mk_backup"
    sudo cp "$mk_backup" /etc/mkinitcpio.conf

    warn "Restoring /etc/default/grub from: $latest_grub_backup"
    sudo cp "$latest_grub_backup" /etc/default/grub

    info "Rebuilding initramfs (mkinitcpio -P)…"
    sudo mkinitcpio -P

    info "Regenerating GRUB configuration…"
    sudo grub-mkconfig -o /boot/grub/grub.cfg

    ok "System restored to pre-Plymouth state."
}

# ==========================================================
# MAIN MENU (NO SUDO HERE AT ALL)
# ==========================================================
while true; do
    section "Plymouth Wizard – Main Menu"

    printf "${CYAN}${BOLD}Select an action:${RESET}\n\n"
    printf "${GREEN} 1)${RESET} Install & Activate Plymouth\n"
    printf "${GREEN} 2)${RESET} Install & Apply Plymouth Theme\n"
    printf "${GREEN} 3)${RESET} Restore & Remove Plymouth Completely\n"
    echo
    printf "${RED} 4)${RESET} Exit Wizard\n\n"

    printf "${YELLOW}Enter choice:${RESET} "
    read -r choice

    case "$choice" in
        1) install_plymouth_step ;;
        2) theme_selection_step ;;
        3) restore_step ;;
        4)
            echo
            info "Exiting wizard. Goodbye!"
            exit 0
            ;;
        *)
            echo
            warn "Invalid option, please try again."
            ;;
    esac
done
