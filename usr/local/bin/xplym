#!/usr/bin/env bash
# ==========================================================
#   Arch Linux Plymouth Wizard – Final Interactive Edition
#   • No sudo required on launch
#   • Human-readable package descriptions
#   • Human-readable installed theme names (Name=)
#   • Bulletproof .plymouth detection
# ==========================================================

set -euo pipefail

# =========================[ COLORS ]========================
RESET="\e[0m"
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
BOLD="\e[1m"

# =====================[ Centered Section Header ]=====================
section() {
    local text="$1"
    local width=47
    local padding=$(( (width - ${#text}) / 2 ))
    local pad=""
    printf -v pad "%*s" "$padding"

    printf "\n${MAGENTA}${BOLD}───────────────────────────────────────────────\n"
    printf "%s%s%s\n" "$pad" "$text" "$pad"
    printf "───────────────────────────────────────────────${RESET}\n"
}

# =========================[ HELPERS ]========================
info()   { printf "${CYAN}➜ %s${RESET}\n" "$1"; }
ok()     { printf "${GREEN}✔ %s${RESET}\n" "$1"; }
warn()   { printf "${YELLOW}⚠ %s${RESET}\n" "$1"; }
error()  { printf "${RED}✖ %s${RESET}\n" "$1"; exit 1; }

BACKUP_DIR="/etc/plymouth-backups"
TIME_STAMP="$(date +%Y%m%d_%H%M%S)"

# ==========================================================
# BACKUP CONFIG FILES
# ==========================================================
backup_configs() {
    section "BACKUP — Saving System Boot Configs"

    [[ ! -d "$BACKUP_DIR" ]] && sudo mkdir -p "$BACKUP_DIR"

    sudo cp /etc/mkinitcpio.conf "$BACKUP_DIR/mkinitcpio.conf.bak_$TIME_STAMP"
    sudo cp /etc/default/grub "$BACKUP_DIR/grub.bak_$TIME_STAMP"

    ok "Backup created at $BACKUP_DIR"
}

# ==========================================================
# FIX HOOKS: Insert plymouth right after udev
# ==========================================================
fix_mkinitcpio_hooks() {
    info "Updating mkinitcpio HOOKS…"

    local file="/etc/mkinitcpio.conf"
    local hooks_line=$(grep "^HOOKS=" "$file" || true)
    [[ -z "$hooks_line" ]] && error "Couldn't locate HOOKS= line in $file"

    local raw_hooks=$(echo "$hooks_line" | sed -E 's/^HOOKS=\((.*)\)/\1/')
    IFS=' ' read -r -a hooks <<< "$raw_hooks"

    # Remove old instances of plymouth
    local cleaned=()
    for h in "${hooks[@]}"; do
        [[ "$h" != "plymouth" ]] && cleaned+=("$h")
    done

    local new=()
    local inserted=false

    for h in "${cleaned[@]}"; do
        new+=("$h")
        if [[ "$h" == "udev" ]]; then
            new+=("plymouth")
            inserted=true
        fi
    done

    if ! $inserted; then
        warn "udev hook missing — prepending udev + plymouth"
        new=("udev" "plymouth" "${cleaned[@]}")
    fi

    sudo sed -i "s|^HOOKS=.*|HOOKS=(${new[*]})|" "$file"
    ok "HOOKS updated."
}

# ==========================================================
# SAFE GRUB FLAG APPENDING
# ==========================================================
append_kernel_flags() {
    local add_flags=("quiet" "splash" "loglevel=3" "rd.udev.log_priority=3" "vt.global_cursor_default=0")

    local current=$(grep '^GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub | sed 's/^GRUB_CMDLINE_LINUX_DEFAULT="//;s/"$//')
    local new="$current"

    for flag in "${add_flags[@]}"; do
        [[ "$current" != *"$flag"* ]] && new="$new $flag"
    done

    new=$(echo "$new" | xargs)  # trim spaces

    sudo sed -i "s|^GRUB_CMDLINE_LINUX_DEFAULT=.*|GRUB_CMDLINE_LINUX_DEFAULT=\"$new\"|" /etc/default/grub
    ok "GRUB flags updated."
}

# ==========================================================
# SHOW HUMAN-READABLE PACKAGE LIST FROM PACMAN
# ==========================================================
get_theme_pkg_list() {
    THEMES_PKGS=()
    THEMES_DESC=()

    while IFS= read -r line; do
        pkg=$(echo "$line" | cut -d'/' -f2 | cut -d' ' -f1)
        desc=$(pacman -Si "$pkg" 2>/dev/null | grep -m1 "^Description" | cut -d':' -f2- | sed 's/^ *//')

        [[ -z "$desc" ]] && desc="$pkg"

        THEMES_PKGS+=("$pkg")
        THEMES_DESC+=("$desc")
    done < <(pacman -Ss plymouth-theme | grep -E '^[^/]+/plymouth-theme')
}

# ==========================================================
# SMART THEME DETECTION USING .plymouth FILES
# ==========================================================
select_theme_from_fs() {
    local plyfiles=()
    local ids=()
    local names=()

    mapfile -t plyfiles < <(find /usr/share/plymouth/themes -type f -name "*.plymouth")

    (( ${#plyfiles[@]} == 0 )) && error "No installed themes found."

    for file in "${plyfiles[@]}"; do
        local id name
        id=$(basename "${file%.plymouth}")
        name=$(grep -m1 "^Name=" "$file" | cut -d'=' -f2-)

        [[ -z "$name" ]] && name="$id"

        ids+=("$id")
        names+=("$name")
    done

    printf "${BOLD}Installed Themes:${RESET}\n"
    for i in "${!names[@]}"; do
        printf "${BLUE} [%d]${RESET} %s\n" "$i" "${names[$i]}"
    done

    printf "\n${YELLOW}Choose theme to activate:${RESET} "
    read -r idx

    THEME_NAME="${ids[$idx]}"
}

# ==========================================================
# STEP 1 – INSTALL PLYMOUTH
# ==========================================================
install_plymouth_step() {
    section "STEP 1 — Install Plymouth"

    backup_configs

    sudo pacman -Sy --needed --noconfirm plymouth plymouth-kcm

    fix_mkinitcpio_hooks

    printf "${YELLOW}Append silent boot flags? [Y/n]: ${RESET}"
    read -r yn
    [[ -z "${yn:-}" || "$yn" =~ ^[Yy]$ ]] && append_kernel_flags

    sudo mkinitcpio -P
    sudo grub-mkconfig -o /boot/grub/grub.cfg

    ok "Plymouth installation complete."
}

# ==========================================================
# STEP 2 – INSTALL & APPLY THEME
# ==========================================================
theme_selection_step() {
    section "STEP 2 — Install & Apply Theme"

    get_theme_pkg_list

    (( ${#THEMES_PKGS[@]} == 0 )) && error "No theme packages available."

    printf "${BOLD}Available Theme Packages:${RESET}\n"
    for i in "${!THEMES_PKGS[@]}"; do
        printf "${BLUE} [%d]${RESET} %s\n" "$i" "${THEMES_DESC[$i]}"
    done

    printf "\n${YELLOW}Choose package to install:${RESET} "
    read -r idx

    pkg="${THEMES_PKGS[$idx]}"
    sudo pacman -Sy --needed --noconfirm "$pkg"

    info "Scanning installed themes..."
    select_theme_from_fs

    info "Applying theme: $THEME_NAME"
    sudo plymouth-set-default-theme -R "$THEME_NAME"

    ok "Theme '$THEME_NAME' applied."
}

# ==========================================================
# STEP 3 – RESTORE SYSTEM TO PRE-PLYMOUTH STATE
# ==========================================================
restore_step() {
    section "STEP 3 — Restore System"

    local mk=$(ls -1t "$BACKUP_DIR"/mkinitcpio.conf.bak_* | head -n1 || true)
    local gr=$(ls -1t "$BACKUP_DIR"/grub.bak_* | head -n1 || true)

    [[ -z "$mk" || -z "$gr" ]] && error "No backups available."

    local pkgs=$(pacman -Qq | grep "^plymouth" || true)
    [[ -n "$pkgs" ]] && sudo pacman -Rns --noconfirm $pkgs

    sudo cp "$mk" /etc/mkinitcpio.conf
    sudo cp "$gr" /etc/default/grub

    sudo mkinitcpio -P
    sudo grub-mkconfig -o /boot/grub/grub.cfg

    ok "System restored to pre-Plymouth state."
}

# ==========================================================
# MAIN MENU — NO SUDO HERE
# ==========================================================
while true; do
    section "Plymouth Wizard — Main Menu"

    printf "${GREEN} 1)${RESET} Install & Activate Plymouth\n"
    printf "${GREEN} 2)${RESET} Install & Apply Theme\n"
    printf "${GREEN} 3)${RESET} Restore System\n"
    echo
    printf "${RED} 4)${RESET} Exit Wizard\n\n"

    printf "${YELLOW}Enter choice:${RESET} "
    read -r choice

    case "$choice" in
        1) install_plymouth_step ;;
        2) theme_selection_step ;;
        3) restore_step ;;
        4) info "Goodbye!"; exit 0 ;;
        *) warn "Invalid choice." ;;
    esac
done
